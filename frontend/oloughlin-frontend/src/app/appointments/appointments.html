<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a routerLink="/home">
        <i class="bi bi-house-door"></i> Home
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      Citas
    </li>
  </ol>
</nav>

<div class="container py-4">
  <h2 class="mb-4">Citas</h2>
  <div class="row g-2 mb-3 align-items-end">
    <div class="col-md-3">
      <input class="form-control" type="text" placeholder="Filtrar por cliente" [(ngModel)]="filterCustomer" (input)="applyFilters()" />
    </div>
    <div class="col-md-3">
      <select class="form-select" [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">Todos los estatus</option>
        <option value="scheduled">Scheduled</option>
        <option value="done">Done</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>
    <div class="col-md-3">
      <input class="form-control" type="date" [(ngModel)]="filterStartDate" (change)="applyFilters()" />
    </div>
    <div class="col-md-3">
      <input class="form-control" type="date" [(ngModel)]="filterEndDate" (change)="applyFilters()" />
    </div>
  </div>
  <div class="mb-3 text-end">
    <button class="btn btn-primary" (click)="openAddModal()">
      <i class="bi bi-calendar-plus"></i> Agregar Cita
    </button>
  </div>
  <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th scope="col" style="cursor:pointer;" (click)="sortBy('customer')">
            Cliente
            <span *ngIf="sortColumn === 'customer'">
              <i [class]="sortDirection === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'"></i>
            </span>
          </th>
          <th scope="col">Email</th>
          <th scope="col" style="cursor:pointer;" (click)="sortBy('dateTime')">
            Fecha y Hora
            <span *ngIf="sortColumn === 'dateTime'">
              <i [class]="sortDirection === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'"></i>
            </span>
          </th>
          <th scope="col" style="cursor:pointer;" (click)="sortBy('status')">
            Estatus
            <span *ngIf="sortColumn === 'status'">
              <i [class]="sortDirection === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down'"></i>
            </span>
          </th>
          <th scope="col">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let appointment of pagedAppointments">
          <td>{{ appointment.customerName }}</td>
          <td>{{ appointment.customerEmail }}</td>
          <td>{{ appointment.dateTime | date:'short' }}</td>
          <td>{{ appointment.status }}</td>
          <td>
            <button class="btn btn-sm btn-info me-2" (click)="openEditModal(appointment)">
              <i class="bi bi-pencil"></i> Editar
            </button>
            <button class="btn btn-sm btn-danger" (click)="openDeleteModal(appointment)">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Paginación Bootstrap -->
  <nav *ngIf="totalPages > 1" class="mt-3">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <button class="page-link" (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">&laquo;</button>
      </li>
      <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index" [class.active]="currentPage === i + 1">
        <button class="page-link" (click)="goToPage(i + 1)">{{ i + 1 }}</button>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <button class="page-link" (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">&raquo;</button>
      </li>
    </ul>
  </nav>

  <!-- Modal Agregar -->
  <div *ngIf="showAddModal && selectedAppointment">
    <div class="modal fade show" tabindex="-1" style="display: block;">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Agregar Cita</h5>
            <button type="button" class="btn-close" (click)="closeModals()"></button>
          </div>
          <form #appointmentForm="ngForm" (ngSubmit)="saveAppointment(selectedAppointment)">
            <div class="modal-body">
              <div class="mb-3 position-relative">
                <label class="form-label">Cliente</label>
                <input class="form-control"
                       type="text"
                       [(ngModel)]="customerSearch"
                       name="customerSearch"
                       (input)="filterCustomerOptions()"
                       (focus)="showCustomerDropdown = true"
                       (blur)="hideDropdownWithDelay()"
                       placeholder="Buscar cliente..." required />
                <ul class="list-group position-absolute w-100"
                    *ngIf="showCustomerDropdown && filteredCustomers.length > 0"
                    style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                  <li class="list-group-item list-group-item-action"
                      *ngFor="let customer of filteredCustomers"
                      (mousedown)="selectCustomer(customer)">
                    {{ customer.name }}
                  </li>
                </ul>
              </div>
              <div class="mb-3">
                <label class="form-label">Fecha y Hora</label>
                <input class="form-control" type="datetime-local" [(ngModel)]="selectedAppointment.dateTime" name="dateTime" required />
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">Guardar</button>
              <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade show" (click)="closeModals()"></div>
  </div>

  <!-- Modal Editar -->
  <div *ngIf="showEditModal && selectedAppointment">
    <div class="modal fade show" tabindex="-1" style="display: block;">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Cita</h5>
            <button type="button" class="btn-close" (click)="closeModals()"></button>
          </div>
          <form #appointmentForm="ngForm" (ngSubmit)="saveAppointment(selectedAppointment)">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Cliente</label>
                <input class="form-control" type="text" [value]="selectedAppointment.customerName" name="customerName" readonly />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input class="form-control" type="email" [value]="selectedAppointment.customerEmail" name="customerEmail" readonly />
              </div>
              <div class="mb-3">
                <label class="form-label">Fecha y Hora</label>
                <input class="form-control" type="datetime-local" [(ngModel)]="selectedAppointment.dateTime" name="dateTime" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Estatus</label>
                <select class="form-select" [(ngModel)]="selectedAppointment.status" name="status" required>
                  <option value="scheduled">Scheduled</option>
                  <option value="done">Done</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">Guardar</button>
              <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade show" (click)="closeModals()"></div>
  </div>

  <!-- Modal Eliminar -->
  <div *ngIf="showDeleteModal && selectedAppointment">
    <div class="modal fade show" tabindex="-1" style="display: block;">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Eliminar Cita</h5>
            <button type="button" class="btn-close" (click)="closeModals()"></button>
          </div>
          <div class="modal-body">
            <p>¿Seguro que deseas eliminar esta cita?</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-danger" (click)="deleteAppointment()">Aceptar</button>
            <button class="btn btn-secondary" (click)="closeModals()">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade show" (click)="closeModals()"></div>
  </div>
</div>
